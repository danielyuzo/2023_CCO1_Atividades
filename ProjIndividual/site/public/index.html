<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/index.css">
    <script src="./js/login.js"></script>
    <title>Document</title>
</head>

<body id="body">
    <div id="loginBlocker" class="blocker" onclick="esconderLogin()"></div>
    <div id="deleteBlocker" class="blocker"></div>

    <!-- Header -->
    <div class="header">
        <div>

        </div>
        <ul>
            <li>Home</li>
            <li><a href="cadastro.html">Cadastro</a></li>
            <li><a href="busca.html">Busca</a></li>
            <li onclick="exibirLogin()">Login</li>
        </ul>
    </div>

    <!-- Login -->
    <div id="loginContainer" class="loginCard">
        Nome de usuário:
        <input id="inpNomeLogin">
        Senha:
        <input id="inpSenhaLogin" type="password">
        <button onclick="entrar()">Login</button>
        <span id="spanErroLogin"></span>
    </div>


    <!-- Corpo -->
    <div class="container">
        <div id="divLista" class="lista"></div>
        <div id="divPost"></div>
        <div id="divData" class="data">
            <ul>
                <li onclick="filtrarMes(4)">Maio</li>
                <li onclick="filtrarMes(3)">Abril</li>
                <li onclick="filtrarMes(2)">Março</li>
                <li onclick="filtrarMes(1)">Fevereiro</li>
            </ul>
        </div>
    </div>

    <div id="deleteContainer" class="deleteCard">
        <span id="spanDeleteMsg"></span>
        <button id="butDelete" onclick="">Confirmar</button>
        <button onclick="esconderDelete()">Cancelar</button>
    </div>

    <!-- Footer -->
    <div class="footer">

    </div>
</body>

</html>

<script>

    function batata() {
        var r = Math.floor(Math.random()*255);
        var g = Math.floor(Math.random()*255);
        var b = Math.floor(Math.random()*255);
        body.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        r = Math.floor(Math.random()*255);
        g = Math.floor(Math.random()*255);
        b = Math.floor(Math.random()*255);
        body.style.color = `rgb(${r}, ${g}, ${b})`;
    }

    var listaPosts = [];

    function atualizarLista() {
        fetch("/post/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                divLista.innerHTML = '';
                resposta.json().then(dados => {
                    console.log(dados);
                    listaPosts = dados;
                    for (var i = 0; i < dados.length; i++) {
                        divLista.innerHTML += `<div class="post" onclick="selecionarPost(${dados[i].idPost})">
                                <h3>${dados[i].titulo}</h3>
                                <p>${dados[i].textoPost}</p>
                                <span>Criado em: ${(new Date(dados[i].dataCriacao)).toDateString()} por ${dados[i].username}</span>
                            </div>`;
                    }
                });
            } else {
                throw ("Houve um erro ao obter as postagens!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function selecionarPost(idPost) {

        var post = listaPosts.find((x)=>x.idPost == idPost);

        // fetch(`/post/visualizar/${idPost}`, {
        //     method: "GET",
        //     headers: {
        //         "Content-Type": "application/json"
        //     }
        // }).then(function (resposta) {

        //     console.log("resposta: ", resposta);

        //     if (resposta.ok) {
        divPost.innerHTML = '';
        // resposta.json().then(dados => {
        var texto =  `<div class="post">
                    <h3><span class="botao" onclick="voltar()">&lt;</span>${post.titulo}</h3>
                    <p>${post.textoPost}</p>
                    <span>Criado em: ${new Date(post.dataCriacao).toDateString()} por ${post.username}</span>`
        if (sessionStorage.ADMIN) {
            texto += `<div><button onclick="editarPost(${post.idPost})">Editar</button>
                        <button onclick="exibirApagarPost(${post.idPost})">Apagar</button></div>`;
        }
        texto += '</div>';
        divPost.innerHTML = texto;
        // });
        fetch(`/comentario/listar/${idPost}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(dados => {
                    if (dados[0].textoComentario != null) {
                        var texto = '';
                        for (var i = 0; i < dados.length; i++) {
                            texto += `<div id="comentario${dados[i].idComentario}" class="comentario">
                            <p>${dados[i].textoComentario}</p>
                            <span>Criado em: ${new Date(dados[i].dataCriacao).toDateString()} por ${dados[i].username}</span>`;    
                            if (dados[i].idUsuario == sessionStorage.ID_USUARIO) {
                                texto += `<div><button onclick="editarComentario(${dados[i].idComentario})">Editar</button>
                                            <button onclick="exibirApagarComentario(${dados[i].idComentario})">Apagar</button></div>`;
                            }
                            texto += '</div>'
                        }
                        divPost.innerHTML += texto;
                    }
                });
            } else {
                throw ("Houve um erro ao obter os comentários!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
        //     } else {
        //         throw ("Houve um erro ao obter as postagens!");
        //     }
        // }).catch(function (resposta) {
        //     console.log(`#ERRO: ${resposta}`);
        // });
        divLista.style.display = 'none';
        divPost.style.display = 'flex';
    }

    function voltar() {
        atualizarLista();
        divPost.innerHTML = '';
        divPost.style.display = 'none';
        divLista.style.display = 'flex';
    }

    var postParaApagar = null;

    function exibirApagarPost(idPost) {
        postParaApagar = idPost;
        spanDeleteMsg.innerHTML = 'Deseja excluir o post?'
        butDelete.onclick = apagarPost;
        deleteBlocker.style.display = 'block';
        deleteContainer.style.display = 'flex';
    }

    function apagarPost() {
        alert('batata');
        fetch("/post/apagar", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idPostServer: postParaApagar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")
            if (resposta.ok) {
                esconderDelete();
                voltar();
                postParaApagar = null;
            } else {
                console.log("Houve um erro ao tentar apagar o post!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function editarComentario(idComentario) {

    }

        var comentarioParaApagar = null;
    
    function exibirApagarComentario(idComentario) {
        comentarioParaApagar = idComentario;
        spanDeleteMsg.innerHTML = 'Deseja excluir o comentário?'
        butDelete.onclick = apagarComentario;
        deleteBlocker.style.display = 'block';
        deleteContainer.style.display = 'flex';
    }

    function apagarComentario() {
        fetch("/comentario/apagar", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idComentarioServer: comentarioParaApagar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")
            if (resposta.ok) {
                esconderDelete();
                var elemento = document.getElementById('comentario' + comentarioParaApagar);
                elemento.remove();
                comentarioParaApagar = null;
            } else {
                console.log("Houve um erro ao tentar apagar o comentário!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function esconderDelete() {      
        butDelete.onclick = '';  
        spanDeleteMsg.innerHTML = '';
        deleteBlocker.style.display = 'none';
        deleteContainer.style.display = 'none';
    }

    atualizarLista();




</script>