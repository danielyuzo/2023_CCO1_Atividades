<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/index.css">
    <script src="./js/login.js"></script>
    <script src="./js/funcoes.js"></script>
    <title>Document</title>
</head>

<body>
    <svg height="600" width="200" class="svgLeft">
        <path d="M0 0 Q140 0 100 145 
        Q100 155 110 160 
        L108 165 
        Q65 160 75 240 
        Q100 360 140 320 
        L145 325 
        Q130 340 145 370 
        S230 580 0 580" stroke="darkturquoise" stroke-width="3" fill="none" />
    </svg> 
    <svg height="600" width="200" class="svgRight">
        <path d="M200 0 
        Q60 0 100 145 
        Q100 155 90 160 
        L92 165 
        Q135 160 125 240 
        Q100 360 60 320 
        L55 325 
        Q70 340 55 370 
        S-30 580 200 580" stroke="darkturquoise" stroke-width="3" fill="none" />
    </svg> 

    <div id="loginBlocker" class="blocker" onclick="esconderLogin()"></div>
    <div id="deleteBlocker" class="blocker"></div>

    <!-- Header -->
    <div class="header" id="divHeader">
    </div>

    <!-- Login -->
    <div id="loginContainer" class="loginCard">
        Nome de usuário:
        <input id="inpNomeLogin">
        Senha:
        <input id="inpSenhaLogin" type="password">
        <button onclick="entrar()">Login</button>
        <span id="spanErroLogin"></span>
    </div>


    <!-- Corpo -->
    <div class="container">
        <div id="divLista" class="lista"></div>
        <div id="divPost"></div>
        <div id="divData" class="data">
            <ul>
                <li onclick="filtrarMes(4)">Maio</li>
                <li onclick="filtrarMes(3)">Abril</li>
                <li onclick="filtrarMes(2)">Março</li>
                <li onclick="filtrarMes(1)">Fevereiro</li>
            </ul>
        </div>
    </div>

    <div id="deleteContainer" class="deleteCard">
        <span id="spanDeleteMsg"></span>
        <button id="butDelete" onclick="">Confirmar</button>
        <button onclick="esconderDelete()">Cancelar</button>
    </div>

    <!-- Footer -->
    <div class="footer" id="divFooter">
    </div>
</body>

</html>

<script>

    var listaPosts = [];

    function atualizarLista() {
        fetch("/post/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                divLista.innerHTML = '';
                resposta.json().then(dados => {
                    console.log(dados);
                    listaPosts = dados;
                    for (var i = 0; i < dados.length; i++) {
                        divLista.innerHTML += `<div class="post" onclick="selecionarPost(${dados[i].idPost})">
                                <h3>${dados[i].titulo}</h3>
                                <p>${dados[i].textoPost}</p>
                                <span>Criado em: ${(new Date(dados[i].dataCriacao)).toDateString()} por ${dados[i].username}</span>
                            </div>`;
                    }
                });
            } else {
                throw ("Houve um erro ao obter as postagens!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }


    function selecionarPost(idPost) {

        var post = listaPosts.find((x) => x.idPost == idPost);

        divPost.innerHTML = '';
        var texto = `<div class="post">
                    <h3><span class="botao" onclick="voltar()">&lt;</span>${post.titulo} ${post.visualizacoes}</h3>

                    <div id="divShowPost${idPost}" class="mostrarCard">
                        <p id="pPost${idPost}">${post.textoPost}</p>
                        <span>Criado em: ${new Date(post.dataCriacao).toDateString()} por ${post.username}</span>`
        if (sessionStorage.ADMIN) {
            texto += `<div><button onclick="exibirEditarPost(${post.idPost})">Editar</button>
                    <button onclick="exibirApagarPost(${post.idPost})">Apagar</button></div></div>
                    <div id="divEditPost${idPost}" class="editarCard">
                        <textarea id="txtPost${idPost}" rows="5" cols="50"></textarea><br>
                        <button onclick="editarPost(${idPost})">Confirmar</button>
                        <button onclick="esconderEditarPost(${idPost})">Cancelar</button>
                    </div>
                    </div>`;
        } else {
            texto += '</div></div>';
        }
        divPost.innerHTML = texto;

        fetch(`/comentario/listar/${idPost}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(dados => {
                    if (dados[0].textoComentario != null) {
                        var texto = '';
                        for (var i = 0; i < dados.length; i++) {
                            texto += `<div id="comentario${dados[i].idComentario}" class="comentario">
                            <div id="divShowComentario${dados[i].idComentario}">
                            <p id="pComentario${dados[i].idComentario}">${dados[i].textoComentario}</p>
                            <span>Criado em: ${new Date(dados[i].dataCriacao).toDateString()} por ${dados[i].username}</span>`;
                            if (dados[i].idUsuario == sessionStorage.ID_USUARIO) {
                                texto += `<div><button onclick="exibirEditarComentario(${dados[i].idComentario})">Editar</button>
                                        <button onclick="exibirApagarComentario(${dados[i].idComentario})">Apagar</button></div></div>
                                        <div id="divEditComentario${dados[i].idComentario}" class="editarCard">
                                            <textarea id="txtComentario${dados[i].idComentario}" rows="5" cols="50"></textarea><br>
                                            <button onclick="editarComentario(${dados[i].idComentario})">Confirmar</button>
                                            <button onclick="esconderEditarComentario(${dados[i].idComentario})">Cancelar</button>
                                        </div></div>`;
                            } else {
                                texto += '</div></div>'
                            }
                        }
                        divPost.innerHTML += texto;
                    }
                });
            } else {
                throw ("Houve um erro ao obter os comentários!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

        fetch('/post/visualizar', {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idPostServer: idPost
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                // Alterar visualizações
            }
        }).catch(function (erro) {
            console.log(erro);
        });
        divLista.style.display = 'none';
        divPost.style.display = 'flex';
    }

    function voltar() {
        atualizarLista();
        divPost.innerHTML = '';
        divPost.style.display = 'none';
        divLista.style.display = 'flex';
    }



    function exibirEditarPost(idPost) {
        var pPost = document.getElementById('pPost' + idPost);
        var divEditPost = document.getElementById('divEditPost' + idPost);
        var divShowPost = document.getElementById('divShowPost' + idPost)
        var textArea = document.getElementById('txtPost' + idPost);

        divEditPost.style.display = 'block';
        divShowPost.style.display = 'none';
        textArea.value = pPost.innerHTML;
    }

    function editarPost(idPost) {
        var textArea = document.getElementById('txtPost' + idPost);
        var textoPost = textArea.value;

        fetch("/post/atualizar", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idPostServer: idPost,
                textoPostServer: textoPost
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO atualizar()!")
            if (resposta.ok) {
                var pPost = document.getElementById('pPost' + idPost);
                pPost.innerHTML = textoPost;
                esconderEditar(idPost);
            } else {
                console.log("Houve um erro ao tentar atualizar o post!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function esconderEditarPost(idPost) {
        var divEditPost = document.getElementById('divEditPost' + idPost);
        var divShowPost = document.getElementById('divShowPost' + idPost)
        var textArea = document.getElementById('txtPost' + idPost);

        divEditPost.style.display = 'none';
        divShowPost.style.display = 'block';
        textArea.innerHTML = '';
    }


    var postParaApagar = null;

    function exibirApagarPost(idPost) {
        postParaApagar = idPost;
        spanDeleteMsg.innerHTML = 'Deseja excluir o post?'
        butDelete.onclick = apagarPost;
        deleteBlocker.style.display = 'block';
        deleteContainer.style.display = 'flex';
    }

    function apagarPost() {
        fetch("/post/apagar", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idPostServer: postParaApagar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")
            if (resposta.ok) {
                esconderDelete();
                voltar();
                postParaApagar = null;
            } else {
                console.log("Houve um erro ao tentar apagar o post!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }



    function exibirEditarComentario(idComentario) {
        var pComentario = document.getElementById('pComentario' + idComentario);
        var divEditComentario = document.getElementById('divEditComentario' + idComentario);
        var divShowComentario = document.getElementById('divShowComentario' + idComentario)
        var textArea = document.getElementById('txtComentario' + idComentario);

        divEditComentario.style.display = 'block';
        divShowComentario.style.display = 'none';
        textArea.value = pComentario.innerHTML;
    }

    function editarComentario(idComentario) {
        var textArea = document.getElementById('txtComentario' + idComentario);
        var textoComentario = textArea.value;

        fetch("/comentario/atualizar", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idComentarioServer: idComentario,
                textoComentarioServer: textoComentario
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO atualizar()!")
            if (resposta.ok) {
                var pComentario = document.getElementById('pComentario' + idComentario);
                pComentario.innerHTML = textoComentario;
                esconderEditarComentario(idComentario);
            } else {
                console.log("Houve um erro ao tentar atualizar o comentário!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function esconderEditarComentario(idComentario) {
        var divEditComentario = document.getElementById('divEditComentario' + idComentario);
        var divShowComentario = document.getElementById('divShowComentario' + idComentario)
        var textArea = document.getElementById('txtComentario' + idComentario);

        divEditComentario.style.display = 'none';
        divShowComentario.style.display = 'block';
        textArea.innerHTML = '';
    }


    var comentarioParaApagar = null;

    function exibirApagarComentario(idComentario) {
        comentarioParaApagar = idComentario;
        spanDeleteMsg.innerHTML = 'Deseja excluir o comentário?'
        butDelete.onclick = apagarComentario;
        deleteBlocker.style.display = 'block';
        deleteContainer.style.display = 'flex';
    }

    function apagarComentario() {
        fetch("/comentario/apagar", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idComentarioServer: comentarioParaApagar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")
            if (resposta.ok) {
                esconderDelete();
                var elemento = document.getElementById('comentario' + comentarioParaApagar);
                elemento.remove();
                comentarioParaApagar = null;
            } else {
                console.log("Houve um erro ao tentar apagar o comentário!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    function esconderDelete() {
        butDelete.onclick = '';
        spanDeleteMsg.innerHTML = '';
        deleteBlocker.style.display = 'none';
        deleteContainer.style.display = 'none';
    }


    printarHeader();
    printarFooter();
    atualizarLista();
</script>